{% extends "base.html" %}

{% block title %}Сброс пароля | Фотоконкурс{% endblock %}

{% block content %}
<section class="auth-section">
    <div class="container auth-container">
        <div class="auth-form-wrapper">
            <h1 class="auth-title">Смена пароля</h1>
            
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <form class="auth-form" method="POST" id="resetPasswordForm">
                {{ form.hidden_tag() }}

                <div class="form-group">
                    <label for="password">Новый пароль</label>
                    {% if form %}
                        {{ form.password(class="form-control", placeholder="Не менее 8 символов",
                                      **{'data-toggle': 'password-requirements'}) }}
                        {% if form.password.errors %}
                            <div class="error-message password-requirements">
                                {{ form.password.errors[0] }}
                            </div>
                        {% endif %}
                    {% else %}
                        <input type="password" id="password" name="password" class="form-control"
                               placeholder="Не менее 8 символов" required
                               data-toggle="password-requirements">
                    {% endif %}

                    <!-- Блок с требованиями к паролю (как на регистрации) -->
                    <div class="password-requirements-list">
                        <small>Пароль должен содержать:</small>
                        <ul>
                            <li data-requirement="length">✓ Минимум 8 символов</li>
                            <li data-requirement="uppercase">✓ Хотя бы одна заглавная буква</li>
                            <li data-requirement="lowercase">✓ Хотя бы одна строчная буква</li>
                            <li data-requirement="digit">✓ Хотя бы одна цифра</li>
                            <li data-requirement="special">✓ Хотя бы один специальный символ (!@#$%^&*(),.?":{}|<>)</li>
                        </ul>
                    </div>
                </div>

                <div class="form-group">
                    <label for="confirm_password">Подтвердите новый пароль</label>
                    {% if form %}
                        {{ form.confirm_password(class="form-control", placeholder="Повторите новый пароль") }}
                        {% if form.confirm_password.errors %}
                            <div class="error-message">{{ form.confirm_password.errors[0] }}</div>
                        {% endif %}
                    {% else %}
                        <input type="password" id="confirm_password" name="confirm_password" class="form-control" placeholder="Повторите новый пароль" required>
                    {% endif %}
                </div>

                <button type="submit" class="btn btn-submit">Изменить пароль</button>

                <div class="auth-footer">
                    <p>После изменения пароля вы будете автоматически авторизованы.</p>
                </div>
            </form>
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const passwordInput = document.getElementById('password');
    const requirementItems = document.querySelectorAll('.password-requirements-list li');

    // Запрещаем переходы с страницы
    let formChanged = false;
    const form = document.getElementById('resetPasswordForm');
    const inputs = form.querySelectorAll('input');

    // Отслеживаем изменения в форме
    inputs.forEach(input => {
        input.addEventListener('input', function() {
            formChanged = true;
        });
    });

    // Предупреждаем при попытке уйти со страницы
    window.addEventListener('beforeunload', function(e) {
        if (formChanged) {
            e.preventDefault();
            e.returnValue = 'Вы ввели данные в форму. Если вы уйдете со страницы, изменения будут потеряны.';
        }
    });

    // Разрешаем переход только после успешной отправки формы
    form.addEventListener('submit', function() {
        window.removeEventListener('beforeunload', arguments.callee);
    });

    // Валидация пароля в реальном времени (как на регистрации)
    if (passwordInput && requirementItems.length > 0) {
        passwordInput.addEventListener('input', function() {
            const password = this.value;

            // Проверка длины
            toggleRequirement('length', password.length >= 8);

            // Проверка заглавных букв
            toggleRequirement('uppercase', /[A-ZА-Я]/.test(password));

            // Проверка строчных букв
            toggleRequirement('lowercase', /[a-zа-я]/.test(password));

            // Проверка цифр
            toggleRequirement('digit', /\d/.test(password));

            // Проверка специальных символов
            toggleRequirement('special', /[!@#$%^&*(),.?":{}|<>]/.test(password));
        });

        function toggleRequirement(type, isValid) {
            const item = document.querySelector(`[data-requirement="${type}"]`);
            if (item) {
                if (isValid) {
                    item.classList.add('valid');
                    item.classList.remove('invalid');
                } else {
                    item.classList.add('invalid');
                    item.classList.remove('valid');
                }
            }
        }
    }
});
</script>

<style>
.auth-section {
    min-height: 100vh;
    display: flex;
    align-items: center;
}

.auth-container {
    max-width: 400px;
}

.alert {
    padding: 12px;
    border-radius: 4px;
    margin-bottom: 20px;
}

.alert-success {
    background-color: #d4edda;
    border-color: #c3e6cb;
    color: #155724;
}

.alert-danger {
    background-color: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
}

.error-message {
    color: #dc3545;
    font-size: 14px;
    margin-top: 5px;
}

.error-message.password-requirements {
    background-color: #fff5f5;
    border: 1px solid #ff4757;
    border-radius: 4px;
    padding: 10px;
    margin-top: 8px;
}

.auth-footer {
    text-align: center;
    margin-top: 20px;
    color: #666;
    font-size: 14px;
}

.password-requirements-list {
    margin-top: 8px;
    padding: 10px;
    background-color: #f8f9fa;
    border-radius: 4px;
    border: 1px solid #e9ecef;
}

.password-requirements-list small {
    display: block;
    margin-bottom: 5px;
    color: #6c757d;
    font-weight: 500;
}

.password-requirements-list ul {
    margin: 0;
    padding-left: 20px;
}

.password-requirements-list li {
    font-size: 12px;
    margin-bottom: 2px;
    transition: color 0.2s ease;
}

.password-requirements-list li.valid {
    color: #28a745;
}

.password-requirements-list li.invalid {
    color: #dc3545;
}

.password-requirements-list li:before {
    content: '✓ ';
    font-weight: bold;
}

.password-requirements-list li.valid:before {
    content: '✓ ';
    color: #28a745;
}

.password-requirements-list li.invalid:before {
    content: '✗ ';
    color: #dc3545;
}

.btn-submit {
    width: 100%;
    padding: 12px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    cursor: pointer;
}

.btn-submit:hover {
    background-color: #0056b3;
}

.form-control {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 16px;
    box-sizing: border-box;
}

.form-control:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
}
</style>
{% endblock %}